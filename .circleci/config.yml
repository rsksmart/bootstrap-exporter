# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: circleci/openjdk:8-jdk

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/postgres:9.4

    working_directory: ~/repo

    environment:
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3200m
      TERM: dumb

    steps:
      - checkout
      - run:
          name: Clone and Build RSKj
          command: |
                  GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_fingerprint'
                  git clone git@github.com:rsksmart/rskj.git ~/rsksmart/rskj
                  cd ~/rsksmart/rskj/
                  ./configure.sh
                  ./gradlew clean build -x test
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "exporter/build.gradle" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-  
      - run: 
          name: Gradle dependencies
          command: |
                  cd exporter
                  gradle dependencies
      - run:
          name: Start RSKj & wait for synch process
          command: |
                  java -Dminer.client.autoMine=true -Drpc.providers.web.ws.enabled=true -cp ~/rsksmart/rskj/rskj-core/build/libs/rskj-core-2.1.0-SNAPSHOT-all.jar co.rsk.Start --regtest  nohup &               
                  sleep 180
      
      - run: 
          name: Build export 
          command: |
                cd exporter
                docker build -t exporter .  

      - run:
          name: Run export process
          command: |
                docker run -v /var/lib/rsk/database:/database -v output:/output exporter 1000 
      - save_cache:
          paths:
            - ~/.gradle
          key: v1-dependencies-{{ checksum "build.gradle" }}

